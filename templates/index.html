<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Dashboard</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');
        
        body {
            margin: 0;
            font-family: 'Roboto', sans-serif;
            background-image: url('background.jpeg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: #2c3e50;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            max-width: 100vw;
            overflow-x: hidden;
        }

        header {
            width: 100%;
            background: #ffffff;
            padding: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        header img {
            height: 50px;
            width: auto;
            object-fit: contain;
            border-radius: 8px;
            margin-right: 15px;
        }

        header h1 {
            margin: 0;
            color: rgb(206,163,190);
        }

        .header-buttons {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logout-button {
            background: rgb(206,163,190);
            color: white;
            padding: 8px 20px;
            border-radius: 8px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .logout-button:hover {
            background: #b77da1;
            transform: translateY(-2px);
        }

        .emergency-button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
        }

        .emergency-button img {
            height: 40px;
            transition: transform 0.2s;
        }

        .emergency-button:hover img {
            transform: scale(1.1);
        }

        .patient-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin: 20px auto;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 20px;
            width: 90%;
            max-width: 500px;
        }

        .patient-card img {
            width: 60px;
            height: 60px;
        }

        .multi-box-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            width: 90%;
            max-width: 1000px;
            margin: 20px auto;
        }

        .box {
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .mint {
            background-color: rgb(206,163,190);
            color: white;
        }

        .white {
            background-color: white;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            margin-top: 10px;
            overflow: hidden;
        }

        .progress-bar span {
            display: block;
            height: 100%;
            background-color: white;
            width: 60%;
            border-radius: 5px;
        }

        .game-widget {
            position: fixed;
            top: 50%;
            left: calc(50% + 340px);
            transform: translateY(-50%);
            width: 350px;
            border-radius: 15px;
            box-shadow: -4px 4px 20px rgba(0, 0, 0, 0.15);
            background: white;
            z-index: 1000;
            overflow: hidden;
        }

        .game-header {
            background: rgb(206,163,190);
            color: white;
            padding: 15px;
            cursor: pointer;
            font-weight: 500;
            text-align: center;
            font-size: 18px;
        }

        .game-body {
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
        }

        .game-input-container {
            display: flex;
            gap: 10px;
            padding: 15px;
            border-top: 1px solid #eee;
        }

        .game-input-container input {
            flex: 1;
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        .game-input-container button {
            background: rgb(206,163,190);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 20px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .game-input-container button:hover {
            background: #b77da1;
        }

        .timer {
            text-align: center;
            font-size: 1.2em;
            color: #FF4081;
            margin: 10px 0;
        }

        .guess-buttons {
            display: none;
            text-align: center;
            margin: 10px 0;
        }

        .guess-button {
            padding: 10px 20px;
            margin: 0 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .human-button {
            background: #4CAF50;
            color: white;
        }

        .bot-button {
            background: #2196F3;
            color: white;
        }

        .typing-indicator {
            color: #666;
            font-style: italic;
            padding: 5px 10px;
            background: #f8f9fa;
            border-radius: 4px;
            margin: 5px;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: .5; }
            50% { opacity: 1; }
            100% { opacity: .5; }
        }

        .partner-message {
            position: relative;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chat-message {
            margin: 8px;
            padding: 8px 12px;
            border-radius: 15px;
            max-width: 80%;
        }

        .user-message {
            background: #007bff;
            color: white;
            margin-left: auto;
        }

        .partner-message {
            background: #e9ecef;
            color: black;
            margin-right: auto;
        }

        .system-message {
            background: #ffc107;
            color: black;
            margin: 8px auto;
            text-align: center;
        }

        .chat-input {
            width: calc(100% - 70px);
            padding: 8px;
            margin-right: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .chat-input:disabled {
            background-color: #f5f5f5;
            cursor: not-allowed;
        }

        .game-input-container button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .play-again-button {
            display: block;
            margin: 10px auto;
            padding: 10px 20px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        .play-again-button:hover {
            background: #45a049;
        }

        .side-nav {
            position: fixed;
            left: 15%;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 20px;
            z-index: 100;
        }

        .side-nav button {
            background: rgba(206,163,190, 0.9);
            color: white;
            border: none;
            border-radius: 15px;
            padding: 15px 30px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 12px;
            width: 200px;
            text-align: left;
        }

        .side-nav button:hover {
            background: rgb(206,163,190);
            transform: translateX(10px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .side-nav button i {
            font-size: 24px;
            width: 30px;
            text-align: center;
        }

        #newsSection {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 600px;
            height: 80vh;
            max-height: 600px;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            z-index: 1001;
        }

        .close-section {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: rgb(206,163,190);
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .multimedia-section {
            width: 50%;
            max-width: 500px;
            margin: 20px auto;
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            color: rgb(206,163,190);
            text-align: center;
            margin-bottom: 20px;
            font-size: 24px;
            display: block;
        }

        .video-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding: 10px;
            max-width: 800px;
            margin: 0 auto;
        }

        .video-wrapper {
            width: 100%;
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .video-wrapper video {
            width: 100%;
            height: 300px;
            object-fit: cover;
            border-radius: 10px;
        }

        .video-wrapper h3 {
            color: rgb(206,163,190);
            margin-bottom: 10px;
            text-align: center;
            font-size: 1.2em;
        }

        iframe {
            width: 100%;
            aspect-ratio: 16/9;
            max-height: 250px;
            border: none;
            border-radius: 10px;
            background: #f5f5f5;
        }

        @media (max-width: 1400px) {
            .side-nav {
                left: 10%;
            }
            
            .game-widget {
                left: calc(50% + 300px);
            }
        }

        @media (max-width: 768px) {
            .side-nav {
                left: 5%;
            }

            .game-widget {
                position: static;
                margin: 20px auto;
                transform: none;
                width: 300px;
            }

            .side-nav button {
                padding: 12px 20px;
                font-size: 16px;
                width: 160px;
            }
        }

        .fun-facts-container {
            max-width: 600px;
            background-color: #ffffff;
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            text-align: center;
            margin: 20px;
        }

        .profile-pic {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid rgb(206,163,190);
        }

        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .timer-container {
            background: white;
            padding: 30px 50px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .timer {
            font-size: 48px;
            font-weight: bold;
            color: rgb(206,163,190);
            margin-bottom: 20px;
            font-family: 'Roboto', sans-serif;
        }

        .cancel-button {
            padding: 12px 30px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }

        .cancel-button:hover {
            background: #c82333;
        }

        /* Add loading animation styles */
        .loading-placeholder {
            position: relative;
            color: transparent;
            background: linear-gradient(100deg, #eceff1 30%, #f5f5f5 50%, #eceff1 70%);
            background-size: 400%;
            animation: loading 1.2s ease-in-out infinite;
            border-radius: 4px;
        }

        @keyframes loading {
            0% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0 50%;
            }
        }

        .patient-info p {
            margin: 8px 0;
        }

        #funFact {
            transition: opacity 0.3s ease;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 0 20px;
        }

        .fun-facts-container button:hover {
            background: #b77da1 !important;
            transform: translateY(-2px);
            transition: all 0.3s ease;
        }

        .status-bar {
            width: 90%;
            max-width: 800px;
            margin: 20px auto;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-around;
            align-items: center;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px 20px;
        }

        .status-item i {
            font-size: 24px;
            color: rgb(206,163,190);
        }

        .status-info {
            display: flex;
            flex-direction: column;
        }

        .status-label {
            font-size: 14px;
            color: #666;
        }

        .status-value {
            font-size: 20px;
            font-weight: bold;
            color: rgb(206,163,190);
        }

        .task-notification {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .task-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            max-width: 80%;
            width: 400px;
        }

        .task-content h3 {
            color: rgb(206,163,190);
            margin-bottom: 10px;
        }

        .task-content p {
            margin: 10px 0;
        }

        .complete-task-button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .complete-task-button:hover {
            background: #45a049;
        }

        .task-info {
            margin-top: 15px;
            padding: 10px 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .task-title {
            color: #2c3e50;
            margin-bottom: 5px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .task-description {
            margin: 0;
            color: #2c3e50;
            font-size: 16px;
            padding: 5px 0;
        }

        .task-icon {
            color: rgb(206,163,190);
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
</head>
    
    <header>
        <img src="bonsai.png" alt="Hospital Logo" style="height: 70px; object-fit: contain;">
        <h1>CURA</h1>
        <div class="header-buttons">
            <button class="emergency-button" onclick="startEmergencyTimer()">
                <img src="emergency.png" alt="Emergency">
            </button>
            <a href="/logout" class="logout-button">
                <i class="fas fa-sign-out-alt"></i>
                Logout
            </a>
        </div>
    </header>

    <div class="overlay">
        <div class="timer-container">
            <div class="timer">5:00</div>
            <button class="cancel-button" onclick="cancelEmergencyTimer()">Cancel</button>
        </div>
    </div>

    <div class="patient-card">
        <img src="profile.jpg" alt="Patient Profile" class="profile-pic">
        <div class="patient-info">
            <p><strong>Name:</strong> <span id="patientName" class="loading-placeholder">Loading...</span></p>
            <p><strong>Wait Time:</strong> <span id="waitTime" class="loading-placeholder">Loading...</span></p>
            <p><strong>Triage Level:</strong> <span id="triageLevel" class="loading-placeholder">Loading...</span></p>
            <div id="activeTask" class="task-info" style="display: none;">
                <p class="task-title">
                    <i class="fas fa-tasks task-icon"></i>
                    <strong>Current Task</strong>
                </p>
                <p id="taskDescription" class="task-description"></p>
            </div>
        </div>
    </div>

    <section class="multi-box-section">
    </section>

    <section class="multimedia-section">
        <h2 class="section-title">Keep yourself engaged!!</h2>
        <div class="video-container">
            <div class="video-wrapper">
                <h3>Relaxation Techniques</h3>
                <video width="100%" height="auto" controls>
                    <source src="video.mp4" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
            </div>
            <div class="video-wrapper">
                <h3>How to Perform Hands-Only CPR</h3>
                <video width="100%" height="auto" controls>
                    <source src="How to Perform Hands-Only CPR.mp4" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
            </div>
        </div>
    </section>

    <div class="fun-facts-container">
        <h2 style="color: rgb(206,163,190); margin-bottom: 20px;">Did You Know?</h2>
        <div id="funFact" style="font-size: 18px; line-height: 1.6; opacity: 0; transition: opacity 0.3s ease;">
       
        </div>
        <button onclick="getNewFunFact()" 
                style="margin-top: 20px; 
                       padding: 10px 20px; 
                       background: rgb(206,163,190); 
                       color: white; 
                       border: none; 
                       border-radius: 8px; 
                       cursor: pointer;">
            Next Fact
        </button>
    </div>

    <div class="game-widget" id="gameWidget">
        <div class="game-header" onclick="toggleGame()">
            🎮 Human or Bot? Game
        </div>
        <div class="game-body" id="gameBody">
            <div class="start-game-container" id="startGameContainer">
                <h3>Ready to play?</h3>
                <p>Chat with someone and guess if they're human or AI!</p>
                <button class="start-game-btn" onclick="startNewGame()">Start Game</button>
            </div>
            <div class="timer" id="gameTimer" style="display: none;">Time: 2:00</div>
            <div id="gameMessages"></div>
            <div class="guess-buttons" id="guessButtons">
                <button class="guess-button human-button" onclick="makeGuess('human')">Human</button>
                <button class="guess-button bot-button" onclick="makeGuess('bot')">Bot</button>
            </div>
            <div class="typing-indicator" id="typingIndicator" style="display: none;">
                Partner is typing...
            </div>
        </div>
        <div class="game-input-container" id="gameInput" style="display: none;">
            <input type="text" class="chat-input" id="gameUserInput" 
                   placeholder="Type your message..." onkeypress="handleGameKeyPress(event)">
            <button onclick="sendGameMessage()">Send</button>
        </div>
    </div>

    <div class="side-nav">
        <button onclick="showMovies()">
            <i class="fas fa-film"></i>
            <span>Entertainment</span>
        </button>
        <button onclick="showNearbyRestaurants()">
            <i class="fas fa-utensils"></i>
            <span>Food Nearby</span>
        </button>
        <button onclick="showNews()">
            <i class="fas fa-newspaper"></i>
            <span>Daily Updates</span>
        </button>
    </div>

    <div id="newsSection">
        <button class="close-section" onclick="closeNews()">×</button>
        <h2>Latest News</h2>
        <div id="newsContent">
        </div>
    </div>

    <div class="modal-overlay" id="modalOverlay"></div>

    <div id="mapModal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80%; height: 80%; background: white; z-index: 1000; border-radius: 10px; overflow: hidden;">
        <div style="position: absolute; top: 10px; right: 10px; z-index: 1001;">
            <button onclick="closeMap()" style="padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">Close</button>
        </div>
        <div id="map" style="width: 100%; height: 100%;"></div>
    </div>

    <script>
        let timeLeft;
        let emergencyTimer;

        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing...');
            try {
                showLoadingState();
                fetchPatientInfo();
                loadInitialFunFact();
            } catch (e) {
                console.error('Error during initial load:', e);
            }
            setInterval(() => {
                try {
                    fetchPatientInfo();
                } catch (e) {
                    console.error('Error during periodic fetch:', e);
                }
            }, 30000);
        });

        function showLoadingState() {
            document.getElementById('patientName').textContent = 'Loading...';
            document.getElementById('waitTime').textContent = 'Loading...';
            document.getElementById('triageLevel').textContent = 'Loading...';
            
            document.getElementById('patientName').classList.add('loading-placeholder');
            document.getElementById('waitTime').classList.add('loading-placeholder');
            document.getElementById('triageLevel').classList.add('loading-placeholder');
        }

        function hideLoadingState() {
            document.getElementById('patientName').classList.remove('loading-placeholder');
            document.getElementById('waitTime').classList.remove('loading-placeholder');
            document.getElementById('triageLevel').classList.remove('loading-placeholder');
        }

        function fetchPatientInfo() {
            console.log('Fetching patient info...');
            fetch('/api/patient-info', {
                credentials: 'same-origin',
                headers: {
                    'Cache-Control': 'no-cache',
                    'Pragma': 'no-cache'
                }
            })
            .then(response => response.json())
            .then(data => {
                hideLoadingState();
                if (data.patientName) {
                    document.getElementById('patientName').textContent = data.patientName;
                    document.getElementById('waitTime').textContent = data.waitTime;
                    document.getElementById('triageLevel').textContent = data.triageLevel;
                    
              
                    const activeTask = document.getElementById('activeTask');
                    const taskDescription = document.getElementById('taskDescription');
                    
                    if (data.activeTask) {
                        taskDescription.textContent = data.activeTask;
                        activeTask.style.display = 'block';
                    } else {
                        activeTask.style.display = 'none';
                    }
                } else {
                    showLoadingState();
                }
            })
            .catch(error => {
                console.error('Detailed fetch error:', error);
                hideLoadingState();
                document.getElementById('patientName').textContent = 'Error loading data';
                document.getElementById('waitTime').textContent = 'Error loading data';
                document.getElementById('triageLevel').textContent = 'Error';
            });

            fetch('/api/notifications')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    const notificationsHtml = data.map(notification => `
                        <div class="notification ${notification.message.includes('Pending') ? 'pending' : ''}">
                            <div>${notification.message}</div>
                            <small>${notification.created_at}</small>
                        </div>
                    `).join('');
                    
                    document.getElementById('notifications').innerHTML = 
                        data.length ? notificationsHtml : '<p>No notifications at this time.</p>';
                })
                .catch(error => {
                    console.error('Error fetching notifications:', error);
                    document.getElementById('notifications').innerHTML = 
                        '<p>Error loading notifications. Please refresh the page.</p>';
                });
        }

        const socket = io();
        let currentGameId = null;
        let gameTimer;
        let canRespond = true;

        socket.on('connect', () => {
            console.log('Connected to WebSocket');
        });

        socket.on('searching_for_partner', () => {
            appendGameMessage('Searching for a partner...', 'system');
            document.getElementById('gameInput').style.display = 'none';
        });

        socket.on('waiting_for_player', () => {
            appendGameMessage('Waiting for another player to join...', 'system');
            document.getElementById('gameInput').style.display = 'none';
        });

        socket.on('game_started', (data) => {
            currentGameId = data.game_id;
            canRespond = true;
            document.getElementById('startGameContainer').style.display = 'none';
            document.getElementById('gameTimer').style.display = 'block';
            appendGameMessage(`Connected with a mystery partner! Chat for 2 minutes, then guess if they're human or AI!`, 'system');
            document.getElementById('gameInput').style.display = 'block';
            document.getElementById('guessButtons').style.display = 'none';
            timeLeft = 120;
            updateTimer();
            gameTimer = setInterval(() => {
                timeLeft--;
                updateTimer();
                
                if (timeLeft <= 0) {
                    clearInterval(gameTimer);
                    endGameWithGuess();
                }
            }, 1000);
        });

        socket.on('game_message', (data) => {
            if (!data.isUser) {
                appendGameMessage(data.message, 'partner');
            }
            canRespond = data.canRespond;
            updateInputState();
        });

        socket.on('typing_indicator', (data) => {
            const typingDiv = document.getElementById('typingIndicator');
            if (data.isTyping) {
                typingDiv.style.display = 'block';
            } else {
                typingDiv.style.display = 'none';
            }
        });

        socket.on('guess_result', (data) => {
            const resultMessage = data.correct ? 
                "Correct! You're a great detective! 🎉" : 
                `Wrong! You were talking to a ${data.was_bot ? 'bot' : 'human'}! 🤔`;
            
            appendGameMessage(resultMessage, 'system');
            const gameMessages = document.getElementById('gameMessages');
            const playAgainButton = document.createElement('button');
            playAgainButton.className = 'play-again-button';
            playAgainButton.textContent = 'Play Again';
            playAgainButton.onclick = () => {
                document.getElementById('gameMessages').innerHTML = '';
                document.getElementById('guessButtons').style.display = 'none';
                socket.emit('join_game');
            };
            gameMessages.appendChild(playAgainButton);
            
            document.getElementById('guessButtons').style.display = 'none';
            document.getElementById('gameInput').style.display = 'none';
        });

        function toggleGame() {
            const gameBody = document.getElementById('gameBody');
            const gameInput = document.getElementById('gameInput');
            const startGameContainer = document.getElementById('startGameContainer');
            
            if (gameBody.style.display === 'none') {
                gameBody.style.display = 'block';
                startGameContainer.style.display = 'block';
                document.getElementById('gameMessages').innerHTML = '';
                document.getElementById('guessButtons').style.display = 'none';
                document.getElementById('gameTimer').style.display = 'none';
            } else {
                endGame();
                gameBody.style.display = 'none';
                gameInput.style.display = 'none';
            }
        }

        function startNewGame() {
            document.getElementById('startGameContainer').style.display = 'none';
            document.getElementById('gameTimer').style.display = 'block';
            document.getElementById('gameMessages').innerHTML = '';
            document.getElementById('guessButtons').style.display = 'none';
            document.getElementById('gameInput').style.display = 'none';
            socket.emit('join_game');
        }

        function sendGameMessage() {
            const input = document.getElementById('gameUserInput');
            const message = input.value.trim();
            
            if (!message || !currentGameId || !canRespond) return;

            socket.emit('game_message', {
                game_id: currentGameId,
                message: message
            });

            appendGameMessage(message, 'user');
            input.value = '';
            canRespond = false;
            updateInputState();
            
            document.getElementById('typingIndicator').style.display = 'none';
        }

        function handleGameKeyPress(event) {
            if (event.key === 'Enter') {
                sendGameMessage();
            }
        }

        function makeGuess(guess) {
            if (!currentGameId) return;
            
            socket.emit('make_guess', {
                game_id: currentGameId,
                guess: guess
            });
        }

        function updateTimer() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            document.getElementById('gameTimer').textContent = 
                `Time: ${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function endGameWithGuess() {
            document.getElementById('gameInput').style.display = 'none';
            document.getElementById('guessButtons').style.display = 'block';
            appendGameMessage("Time's up! Was your partner a human or a bot?", 'system');
        }

        function endGame() {
            currentGameId = null;
            if (gameTimer) {
                clearInterval(gameTimer);
            }
            document.getElementById('gameTimer').textContent = 'Time: 2:00';
            document.getElementById('guessButtons').style.display = 'none';
            document.getElementById('gameInput').style.display = 'none';
            document.getElementById('typingIndicator').style.display = 'none';
        }

        function appendGameMessage(message, sender) {
            const gameMessages = document.getElementById('gameMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `${sender}-message chat-message`;
            
            if (sender === 'user') {
                messageDiv.textContent = message;
            } 
            else if (sender === 'partner') {
                messageDiv.textContent = `Partner: ${message}`;
            }
            else {
                messageDiv.textContent = message;
            }
            
            gameMessages.appendChild(messageDiv);
            gameMessages.scrollTop = gameMessages.scrollHeight;
        }

        function updateInputState() {
            const input = document.getElementById('gameUserInput');
            input.disabled = !canRespond;
            input.classList.toggle('disabled', !canRespond);
        }

        document.getElementById('gameUserInput').addEventListener('input', (e) => {
            if (currentGameId && canRespond) {
                socket.emit('user_typing', {
                    game_id: currentGameId,
                    isTyping: e.target.value.length > 0
                });
            }
        });

        function showMovies() {
            window.location.href = '/entertainment';
        }

        function showNews() {
            window.location.href = '/news';
        }

        function closeNews() {
            document.getElementById('newsSection').style.display = 'none';
            document.getElementById('modalOverlay').style.display = 'none';
        }

        const funFacts = [
            "The human body contains enough iron to make a 3-inch nail.",
            "Your heart beats about 100,000 times every day.",
            "The human brain can process images in as little as 13 milliseconds.",
            "The average person spends 6 months of their lifetime waiting for red lights to turn green.",
            "A sneeze can travel up to 100 miles per hour.",
            "The human body produces enough heat in 30 minutes to boil a gallon of water.",
            "The average person walks the equivalent of three times around the world in a lifetime.",
            "Your body has enough blood vessels to circle the Earth 2.5 times.",
            "The human body sheds about 600,000 particles of skin every hour.",
            "Your brain uses 20% of your body's total energy."
        ];

        function getNewFunFact() {
            const funFactElement = document.getElementById('funFact');
            if (!funFactElement) {
                console.error('Fun fact element not found');
                return;
            }
            
            const randomFact = funFacts[Math.floor(Math.random() * funFacts.length)];
            
            funFactElement.style.opacity = '0';
            
            setTimeout(() => {
                funFactElement.textContent = randomFact;
                funFactElement.style.opacity = '1';
            }, 300);
        }

        function loadInitialFunFact() {
            const funFactElement = document.getElementById('funFact');
            if (funFactElement) {
                const randomFact = funFacts[Math.floor(Math.random() * funFacts.length)];
                funFactElement.textContent = randomFact;
                funFactElement.style.opacity = '1';
            } else {
                console.error('Fun fact element not found');
            }
        }

        function showNearbyRestaurants() {
            document.getElementById('mapModal').style.display = 'block';
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const currentLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    const map = L.map('map').setView([currentLocation.lat, currentLocation.lng], 15);
                    
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '© OpenStreetMap contributors'
                    }).addTo(map);
                    
                    L.marker([currentLocation.lat, currentLocation.lng])
                        .bindPopup('You are here')
                        .addTo(map);
                    
                    const radius = 1000; // 1km radius
                    const query = `
                        [out:json][timeout:25];
                        (
                            node["amenity"="restaurant"](around:${radius},${currentLocation.lat},${currentLocation.lng});
                            way["amenity"="restaurant"](around:${radius},${currentLocation.lat},${currentLocation.lng});
                            node["amenity"="cafe"](around:${radius},${currentLocation.lat},${currentLocation.lng});
                            way["amenity"="cafe"](around:${radius},${currentLocation.lat},${currentLocation.lng});
                            node["amenity"="fast_food"](around:${radius},${currentLocation.lat},${currentLocation.lng});
                            way["amenity"="fast_food"](around:${radius},${currentLocation.lat},${currentLocation.lng});
                        );
                        out body;
                        >;
                        out skel qt;
                    `;
                    
                    fetch(`https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.elements) {
                                data.elements.forEach(element => {
                                    if (element.lat && element.lon) {
                                        const name = element.tags.name || 'Unnamed venue';
                                        const cuisine = element.tags.cuisine ? `Cuisine: ${element.tags.cuisine}` : '';
                                        const amenity = element.tags.amenity ? `Type: ${element.tags.amenity}` : '';
                                        
                                        L.marker([element.lat, element.lon])
                                            .bindPopup(`
                                                <strong>${name}</strong><br>
                                                ${cuisine}<br>
                                                ${amenity}
                                            `)
                                            .addTo(map);
                                    }
                                });
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching nearby places:', error);
                            alert('Error loading nearby restaurants. Please try again.');
                        });
                });
            }
        }
        
        function closeMap() {
            document.getElementById('mapModal').style.display = 'none';
        }

        function startEmergencyTimer() {
            document.querySelector('.overlay').style.display = 'flex';
            timeLeft = 5; 
            updateTimerDisplay();
            
            emergencyTimer = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                
                if (timeLeft <= 0) {
                    clearInterval(emergencyTimer);
                    alert('Emergency services have been notified!');
                    document.querySelector('.overlay').style.display = 'none';
                }
            }, 1000);
        }

        function cancelEmergencyTimer() {
            clearInterval(emergencyTimer);
            document.querySelector('.overlay').style.display = 'none';
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            document.querySelector('.timer').textContent = 
                `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        socket.on('notification', function(data) {
            if (data.type === 'task') {
                document.getElementById('taskMessage').textContent = data.message;
                document.querySelector('.task-notification').style.display = 'block';
                
                if (Notification.permission === "granted") {
                    new Notification("New Task", { body: data.message });
                }
            }
        });
        
        function completeTask() {
            fetch('/complete_task/' + currentUserId, {
                method: 'POST',
                credentials: 'same-origin'
            })
            .then(response => {
                if (response.ok) {
                    document.querySelector('.task-notification').style.display = 'none';
                }
            })
            .catch(error => console.error('Error completing task:', error));
        }
    
        if (Notification.permission !== "granted") {
            Notification.requestPermission();
        }
    </script>
</body>
</html>

